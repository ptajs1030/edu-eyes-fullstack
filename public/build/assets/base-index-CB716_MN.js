import{r,j as e,a as v,u as ae,H as se}from"./app-8ncc8UFs.js";import{A as q}from"./action-modal-C6zvC9Wg.js";import{F as ne}from"./form-modal-C8RgelIB.js";import{t as y,T as oe}from"./index-CnkNrzgc.js";import{r as le,u as $,w as re}from"./xlsx-BBWTpfDg.js";import{P as ie}from"./pagination-AMu3xnMp.js";import{T as ce}from"./table-D_xVkHTt.js";import{A as de}from"./app-layout-Bm1L9tl_.js";import me from"./base-form-DcKMWI_s.js";import"./proxy-BLcwRN-s.js";import"./index-T3YtTzOB.js";import"./createLucideIcon-BvZSX5g3.js";import"./button-JhhMo45h.js";import"./index-FzeLkVq2.js";import"./index-DwJh9Lbx.js";import"./app-logo-icon-DToAEddJ.js";const ue=c=>{switch(c){case"parent":return["nama_lengkap","username","pekerjaan","nomor_telepon","email","alamat","password"];case"teacher":return["nama_lengkap","username","nip","posisi","nomor_telepon","email","alamat","password"];default:return[]}},pe=c=>{switch(c){case"parent":return["Nama Lengkap","Username","Pekerjaan","Nomor Telepon","Email","Alamat","Password"];case"teacher":return["Nama Lengkap","Username","NIP","Posisi/Jabatan","Nomor Telepon","Email","Alamat","Password"];default:return[]}},he=c=>c.replace(/\*/g,"").trim().toLowerCase().replace(/\s+/g,"_");function xe({isOpen:c,onClose:B,role:n,routePrefix:O}){const[A,s]=r.useState(null),[d,w]=r.useState(""),[E,S]=r.useState(!1),[u,p]=r.useState(!1),D=()=>{s(null),w(""),S(!1),p(!1)},h=()=>{u||(D(),B())},j=i=>{var g;w("");const l=((g=i.target.files)==null?void 0:g[0])??null;if(!l){s(null);return}const f=["application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/csv"];if(l.type&&!f.includes(l.type)){w("Tipe file tidak didukung. Harap upload .xlsx / .xls"),s(null);return}S(!0);const x=new FileReader;x.onload=k=>{var T;try{const F=(T=k.target)==null?void 0:T.result,m=le(F,{type:"array"}),L=m.SheetNames[0],H=m.Sheets[L],M=($.sheet_to_json(H,{header:1})[0]||[]).map(R=>he(String(R??""))),I=ue(n.value);M.length===I.length&&I.every((R,G)=>R===M[G])?(s(l),y.success("File valid. Siap di-import.")):(w("Header file tidak sesuai template. Gunakan template terbaru."),s(null))}catch{w("Gagal membaca file. Pastikan format Excel valid."),s(null)}finally{S(!1)}},x.readAsArrayBuffer(l)},b=i=>{switch(i.toLowerCase()){case"teacher":return"Guru";case"parent":return"Orang Tua";default:return i}},C=async()=>{var i;try{const l=await fetch(route("users.template",n.value),{method:"GET",cache:"no-store",credentials:"include"});if(!l.ok){const T=((i=await l.json().catch(()=>null))==null?void 0:i.message)||"Gagal mengunduh template";y.error(T);return}const f=await l.blob(),x=window.URL.createObjectURL(f),g=document.createElement("a"),k=l.headers.get("X-File-Name")||`template-import-${n.value}.xlsx`;g.href=x,g.download=k,document.body.appendChild(g),g.click(),g.remove(),window.URL.revokeObjectURL(x),y.success(`Template import ${b(n.name).toLowerCase()} berhasil diunduh`)}catch{y.error("Terjadi kesalahan saat mengunduh template")}},J=()=>{if(!A){w("Pilih file terlebih dahulu");return}p(!0);const i=new FormData;i.append("file",A),v.post(route(`${O}.import`),i,{onStart:()=>p(!0),onSuccess:()=>{p(!1),h(),v.reload()},onError:l=>{const f=(l==null?void 0:l.file)||"Import gagal. Periksa isi file.";y.error(f),p(!1)},onFinish:()=>p(!1),headers:{"Content-Type":"multipart/form-data"},preserveScroll:!0})};return e.jsxs(ne,{isOpen:c,onClose:h,title:`Import Data ${b(n.name)}`,onSubmit:i=>{i.preventDefault(),J()},children:[e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{className:"rounded-lg border border-dashed border-gray-300 p-4",children:[e.jsx("label",{className:"mb-2 block text-sm font-medium text-gray-700",children:"Upload File (.xlsx / .xls)"}),e.jsx("div",{className:"relative mt-1",children:e.jsx("input",{type:"file",accept:".xlsx,.xls,.csv",onChange:j,disabled:u,className:"block w-full text-sm text-gray-500 file:mr-4 file:rounded-md file:border-0 file:bg-blue-50 file:px-4 file:py-2.5 file:text-sm file:font-medium file:text-blue-700 hover:file:bg-blue-100"})}),e.jsx("p",{className:"mt-2 text-xs text-gray-500",children:"Gunakan template agar header sesuai. Maks 2MB."}),d&&e.jsx("div",{className:"mt-2 text-xs text-red-600",children:d}),E&&e.jsxs("div",{className:"mt-2 inline-flex items-center text-xs text-gray-600",children:[e.jsxs("svg",{className:"mr-1.5 h-3.5 w-3.5 animate-spin",viewBox:"0 0 24 24",fill:"none",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor"}),e.jsx("path",{className:"opacity-75",d:"M4 12a8 8 0 018-8v8z",fill:"currentColor"})]}),"Memvalidasi header..."]})]}),e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between ml-1",children:[e.jsxs("button",{type:"button",onClick:C,className:"inline-flex items-center justify-center rounded-md border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm hover:cursor-pointer hover:bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:outline-none",disabled:u,children:[e.jsx("svg",{className:"mr-2 h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",d:"M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5 5m0 0l5-5m-5 5V3"})}),"Template"]}),e.jsxs("div",{className:"text-xs text-gray-500",children:["Header: ",pe(n.value).join(", ")]})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end",children:[e.jsx("button",{type:"button",onClick:h,disabled:u,className:"mr-2 rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:cursor-pointer hover:bg-gray-50",children:"Batal"}),e.jsxs("button",{type:"submit",disabled:u||!A||!!d||E,className:`inline-flex items-center rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm ${u?"cursor-not-allowed bg-blue-400":"bg-blue-600 hover:cursor-pointer hover:bg-blue-700"}`,children:[u&&e.jsxs("svg",{className:"mr-2 h-4 w-4 animate-spin",viewBox:"0 0 24 24",fill:"none",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor"}),e.jsx("path",{className:"opacity-75",d:"M4 12a8 8 0 018-8v8z",fill:"currentColor"})]}),u?"Memproses...":"Impor"]})]})]})}function Pe({users:c,statuses:B,filters:n,breadcrumbs:O,title:A,role:s,routePrefix:d}){const[w,E]=r.useState(!1),[S,u]=r.useState(!1),[p,D]=r.useState(null),[h,j]=r.useState([]),[b,C]=r.useState(null),[J,i]=r.useState(null),[l,f]=r.useState(!1),[x,g]=r.useState(n.show||"10"),[k,T]=r.useState(n.status||"");r.useEffect(()=>{j([])},[x,k,n.search,n.sort,n.direction]);const F=async t=>{if(!t.phone){i(t),f(!0);return}v.put(route(`${d}.reset-password`,t.id),{},{onSuccess:()=>{var U;const o=encodeURIComponent("Password akun EduEyes Anda telah direset. Password baru: eduEyes123");let N=((U=t.phone)==null?void 0:U.replace(/[^0-9]/g,""))||"";N.startsWith("08")&&(N="628"+N.slice(2));const _=`https://wa.me/${N}?text=${o}`;window.open(_,"_blank")},onError:o=>{console.log(o)}})},{flash:m}=ae().props;r.useEffect(()=>{m!=null&&m.success&&y.success(m.success),m!=null&&m.error&&y.error(m.error)},[m]);const L=(t=null)=>{D(t),E(!0)},H=t=>{v.delete(route(`${d}.destroy`,t),{onSuccess:()=>{v.reload()}})},V=t=>{j(o=>o.includes(t)?o.filter(N=>N!==t):[...o,t])},M=()=>{if(h.length===0)return;const t=c.data.filter(P=>h.includes(P.id)),o={active:"Aktif",inactive:"Tidak Aktif"},_=(P=>{switch(P){case"parent":return{headers:["Nama Lengkap","Username","Pekerjaan","Nomor Telepon","Email","Alamat","Status"],baseFilename:"data-orang-tua",getRow:a=>({"Nama Lengkap":a.full_name||"-",Username:a.username||"-",Pekerjaan:a.job||"-","Nomor Telepon":{v:a.phone||"-",t:"s"},Email:a.email||"-",Alamat:a.address||"-",Status:o[a.status]||a.status||"-"})};case"teacher":return{headers:["Nama Lengkap","Username","NIP","Posisi/Jabatan","Nomor Telepon","Email","Alamat","Status"],baseFilename:"data-guru",getRow:a=>({"Nama Lengkap":a.full_name||"-",Username:a.username||"-",NIP:{v:a.nip||"-",t:"s"},"Posisi/Jabatan":a.position||"-","Nomor Telepon":{v:a.phone||"-",t:"s"},Email:a.email||"-",Alamat:a.address||"-",Status:o[a.status]||a.status||"-"})};case"admin":return{headers:["Nama Lengkap","Username","NIP","Posisi/Jabatan","Nomor Telepon","Email","Alamat","Status"],baseFilename:"data-admin",getRow:a=>({"Nama Lengkap":a.full_name||"-",Username:a.username||"-",NIP:{v:a.nip||"-",t:"s"},"Posisi/Jabatan":a.position||"-","Nomor Telepon":{v:a.phone||"-",t:"s"},Email:a.email||"-",Alamat:a.address||"-",Status:o[a.status]||a.status||"-"})};default:return{headers:["Nama Lengkap","Username","Nomor Telepon","Email","Alamat","Role","Status"],baseFilename:"data-user",getRow:a=>{var Y;return{"Nama Lengkap":a.full_name||"-",Username:a.username||"-","Nomor Telepon":{v:a.phone||"-",t:"s"},Email:a.email||"-",Alamat:a.address||"-",Role:((Y=a.role)==null?void 0:Y.name)||"-",Status:o[a.status]||a.status||"-"}}}}})(s.value),U=`${_.baseFilename}.xlsx`,ee=t.map(P=>_.getRow(P)),K=$.json_to_sheet(ee),te=_.headers.map(()=>({width:20}));K["!cols"]=te;const X=$.book_new();$.book_append_sheet(X,K,"Data"),re(X,U),y.success(`Berhasil mengekspor ${t.length} data ${z(s.name)}`,{description:"File CSV telah didownload otomatis"})},I=t=>{v.get(route(`${d}.index`),{sort:t,direction:n.direction==="asc"?"desc":"asc"},{preserveState:!0})},W=t=>{const o=t.target.value;g(o),j([]),v.get(route(`${d}.index`),{...n,show:o,status:k||void 0},{preserveState:!0,replace:!0})},R=t=>{const o=t.target.value;T(o),j([]),v.get(route(`${d}.index`),{...n,status:o||void 0,show:x},{preserveState:!0,replace:!0})},G=[...s.value==="admin"||s.value==="teacher"?[{key:"profile_picture",label:"Foto",sortable:!1}]:[],{key:"full_name",label:"Nama",sortable:!0},...s.value==="admin"||s.value==="teacher"?[{key:"nip",label:"NIP",sortable:!0}]:[],{key:"username",label:"Username",sortable:!0},...s.value==="admin"||s.value==="teacher"?[{key:"position",label:"Jabatan",sortable:!0}]:[{key:"job",label:"Pekerjaan",sortable:!0}],{key:"phone",label:"Nomor Telepon",sortable:!0},{key:"email",label:"Email",sortable:!0},{key:"status",label:"Status",sortable:!0},{key:"address",label:"Alamat",sortable:!0},{key:"actions",label:"Aksi",sortable:!1}],Q=t=>{switch(t){case"active":return"bg-green-100 text-green-800";case"inactive":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}},Z=t=>{switch(t){case"active":return"Aktif";case"inactive":return"Tidak Aktif";default:return t}},z=t=>({Admin:"Admin",Teacher:"Guru",Parent:"Orang Tua"})[t]||t;return e.jsxs(de,{breadcrumbs:O,children:[e.jsx(se,{title:A}),e.jsx(oe,{position:"top-right",richColors:!0}),e.jsxs("div",{className:"flex items-center gap-3 px-6 pt-6 pb-1",children:[e.jsx("input",{type:"text",placeholder:"Cari pengguna...",defaultValue:n.search||"",onChange:t=>{j([]),v.get(route(`${d}.index`),{...n,search:t.target.value,show:x,status:k},{preserveState:!0})},className:"w-64 rounded border bg-white px-3 py-1 text-sm"}),e.jsxs("select",{value:x,onChange:W,className:"min-w-[100px] rounded border bg-white px-2 py-1 text-sm",children:[e.jsx("option",{value:"10",children:"Show 10 data"}),e.jsx("option",{value:"20",children:"Show 20 data"}),e.jsx("option",{value:"all",children:"Show All"})]}),e.jsxs("select",{value:k,onChange:R,className:"min-w-[120px] rounded border bg-white px-2 py-1 text-sm",children:[e.jsx("option",{value:"",children:"Semua Status"}),e.jsx("option",{value:"active",children:"Aktif"}),e.jsx("option",{value:"inactive",children:"Tidak Aktif"})]}),e.jsx("button",{disabled:h.length===0,onClick:M,className:`rounded bg-indigo-600 px-3 py-1 text-sm font-medium text-white hover:bg-indigo-700 ${h.length===0?"cursor-not-allowed opacity-50":"hover:cursor-pointer"}`,children:"Ekspor Data"}),s.value!=="admin"&&e.jsxs("button",{onClick:()=>u(!0),className:"inline-flex items-center rounded bg-blue-600 px-3 py-1 text-sm font-medium text-white hover:cursor-pointer hover:bg-indigo-700",children:[e.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5-5 5 5M12 5v14"})}),"Impor Data"]}),e.jsx("div",{className:"flex-1"}),e.jsxs("button",{onClick:()=>L(null),className:"ml-2 rounded bg-green-600 px-3 py-1 text-sm font-medium text-white transition hover:cursor-pointer hover:bg-green-700",children:["Tambah ",z(s.name)]})]}),e.jsxs("div",{className:"flex flex-col gap-6 rounded-xl bg-white p-6 text-black shadow-lg",children:[e.jsx(ce,{headers:G,data:c.data,sortColumn:n.sort??"",sortDirection:n.direction==="asc"||n.direction==="desc"?n.direction:"asc",onSort:I,onSelectAll:t=>j(t?c.data.map(o=>o.id):[]),selectedIds:h,rowRender:t=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"w-[10px] p-3 text-sm",children:e.jsx("input",{type:"checkbox",checked:h.includes(t.id),onChange:()=>V(t.id)})}),(s.value==="admin"||s.value==="teacher")&&e.jsx("td",{className:"w-[50px] p-3 text-sm",children:e.jsx("div",{className:"h-10 w-10 overflow-hidden rounded-full border shadow-sm",children:e.jsx("img",{src:t.profile_picture?`/storage/${t.profile_picture}`:`https://api.dicebear.com/9.x/initials/svg?seed=${encodeURIComponent(t.full_name)}`,alt:t.full_name,className:"h-full w-full object-cover"})})}),e.jsx("td",{className:"p-3 text-sm",children:t.full_name}),(s.value==="admin"||s.value==="teacher")&&e.jsx("td",{className:"p-3 text-sm",children:t.nip||"-"}),e.jsx("td",{className:"p-3 text-sm",children:t.username}),(s.value==="admin"||s.value==="teacher")&&e.jsx("td",{className:"p-3 text-sm",children:t.position||"-"}),s.value==="parent"&&e.jsx("td",{className:"p-3 text-sm",children:t.job||"-"}),e.jsx("td",{className:"p-3 text-sm",children:t.phone||"-"}),e.jsx("td",{className:"p-3 text-sm",children:t.email||"-"}),e.jsx("td",{className:"p-3 text-sm min-w-[120px] w-[140px]",children:e.jsx("span",{className:`inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${Q(t.status)}`,children:Z(t.status)})}),e.jsx("td",{className:"p-3 text-sm",children:t.address?t.address.length>70?t.address.substring(0,70)+"...":t.address:"-"}),e.jsx("td",{className:"p-3 text-sm",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>L(t),className:"rounded bg-blue-500 px-3 py-1 font-medium text-white hover:cursor-pointer",children:"Edit"}),e.jsx("button",{onClick:()=>C(t),className:"rounded bg-red-500 px-3 py-1 font-medium text-white hover:cursor-pointer",children:"Hapus"}),e.jsx("button",{onClick:()=>F(t),className:"rounded bg-yellow-500 px-5 py-1 font-medium whitespace-nowrap text-white hover:cursor-pointer",children:"Reset Password"})]})})]},t.id)}),e.jsx(ie,{links:c.links}),e.jsx(me,{isOpen:w,onClose:()=>E(!1),user:p,statuses:B,role:s,routePrefix:d},(p==null?void 0:p.id)||"new"),e.jsx(q,{isOpen:!!b,onClose:()=>C(null),title:"Konfirmasi Penghapusan",message:e.jsxs("span",{children:["Apakah Anda yakin ingin menghapus user ",e.jsx("strong",{children:b==null?void 0:b.full_name}),"?"]}),buttons:[{label:"Batal",onClick:()=>C(null),variant:"neutral"},{label:"Ya, Hapus",onClick:()=>{b&&(H(b.id),C(null))},variant:"danger"}]}),e.jsx(q,{isOpen:l,onClose:()=>f(!1),title:"Reset Password Error",message:e.jsx("span",{children:"Phone is not set for this user"}),buttons:[{label:"OK",onClick:()=>f(!1),variant:"neutral"}]}),S&&e.jsx(xe,{isOpen:S,onClose:()=>u(!1),role:s,routePrefix:d})]})]})}export{Pe as default};
