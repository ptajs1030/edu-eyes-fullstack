import{r as l,j as e,a as v,u as z,H as ce,L as de}from"./app-CuqKbMN6.js";import{A as Q}from"./action-modal-Co5SIj8x.js";import{F as me}from"./form-modal-on-qWHus.js";import{t as h,T as ue}from"./index-DxTzc5om.js";import{r as pe,u as K,w as he}from"./xlsx-BBWTpfDg.js";import{P as xe}from"./pagination-BVaGRcAn.js";import{T as ge}from"./table-CE3JGyH2.js";import{A as fe}from"./app-layout-B0Qa0-6x.js";import be from"./form-ChRkiLin.js";/* empty css            */import"./proxy-D8XOPwuh.js";import"./index-J9pqjwX0.js";import"./createLucideIcon-CtOFYahP.js";import"./button-CAPeMKQc.js";import"./index-D1MjfKX7.js";import"./index-Dhs7DcFB.js";import"./app-logo-icon-CUNpaR3U.js";import"./searchable-select-irrp9i0S.js";const we=["Nama Lengkap","Orang Tua/Wali","Kelas","NIS","Tahun Masuk","Jenis Kelamin","Agama","Tempat Lahir","Tanggal Lahir","Alamat"],ye=["Nama Lengkap*","Orang Tua/Wali*","Kelas","NIS","Tahun Masuk*","Jenis Kelamin*","Agama","Tempat Lahir","Tanggal Lahir","Alamat"],V=c=>c.replace(/\*/g,"").trim().toLowerCase().replace(/\s+/g,"_");function ve({isOpen:c,onClose:H}){const[A,x]=l.useState(null),[M,s]=l.useState(""),[d,D]=l.useState(!1),[k,_]=l.useState(!1),$=()=>{x(null),s(""),D(!1),_(!1)},T=()=>{k||($(),H())},R=n=>{var u;s("");const a=((u=n.target.files)==null?void 0:u[0])??null;if(!a){x(null);return}if(a.size>2*1024*1024){s("Ukuran file maksimal 2MB"),x(null);return}const g=["application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/csv"];if(a.type&&!g.includes(a.type)){s("Tipe file tidak didukung. Upload .xlsx / .xls"),x(null);return}D(!0);const N=new FileReader;N.onload=S=>{var C;try{const B=(C=S.target)==null?void 0:C.result,I=pe(B,{type:"array"}),G=I.SheetNames[0],P=I.Sheets[G],L=(K.sheet_to_json(P,{header:1})[0]||[]).map(j=>V(String(j??""))),O=we.map(V),E=O.filter(j=>!L.includes(j)),F=L.filter(j=>!O.includes(j)&&j!=="");E.length>0?(s(`Header tidak lengkap. Field yang kurang: ${E.join(", ")}. Gunakan template yang disediakan.`),x(null)):F.length>0?(console.warn("Header tambahan ditemukan:",F),x(a),h.success("File valid. Header tambahan akan diabaikan.")):(x(a),h.success("File valid. Siap diimpor."))}catch{s("Gagal membaca file. Format Excel tidak valid."),x(null)}finally{D(!1)}},N.readAsArrayBuffer(a)},U=async()=>{var n;try{const a=await fetch(route("students.template"),{method:"GET"});if(!a.ok){const C=((n=await a.json().catch(()=>null))==null?void 0:n.message)||"Gagal mengunduh template";h.error(C);return}const g=await a.blob(),N=window.URL.createObjectURL(g),u=document.createElement("a"),S=a.headers.get("X-File-Name")||"template-import-siswa.xlsx";u.href=N,u.download=S,document.body.appendChild(u),u.click(),u.remove(),window.URL.revokeObjectURL(N),h.success("Template siswa berhasil diunduh")}catch{h.error("Terjadi kesalahan saat mengunduh template")}},m=()=>{if(!A){s("Pilih file terlebih dahulu");return}_(!0);const n=new FormData;n.append("file",A),v.post(route("students.import"),n,{onSuccess:()=>{T(),v.reload()},onError:a=>{const g=(a==null?void 0:a.file)||"Import gagal. Periksa isi file.";h.error(g)},onFinish:()=>_(!1),preserveScroll:!0})};return e.jsxs(me,{isOpen:c,onClose:T,title:"Import Data Siswa",onSubmit:n=>{n.preventDefault(),m()},children:[e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{className:"rounded-lg border border-dashed border-gray-300 p-4",children:[e.jsx("label",{className:"mb-2 block text-sm font-medium text-gray-700",children:"Upload File (.xlsx / .xls)"}),e.jsx("input",{type:"file",accept:".xlsx,.xls,.csv",onChange:R,disabled:k,className:"block w-full text-sm text-gray-500 file:mr-4 file:rounded-md file:border-0 file:bg-blue-50 file:px-4 file:py-2.5 file:text-sm file:font-medium file:text-blue-700 hover:file:bg-blue-100"}),e.jsx("p",{className:"mt-2 text-xs text-gray-500",children:"Gunakan template agar header sesuai. Maks 2MB."}),M&&e.jsx("div",{className:"mt-2 text-xs text-red-600",children:M}),d&&e.jsxs("div",{className:"mt-2 inline-flex items-center text-xs text-gray-600",children:[e.jsxs("svg",{className:"mr-1.5 h-3.5 w-3.5 animate-spin",viewBox:"0 0 24 24",fill:"none",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor"}),e.jsx("path",{className:"opacity-75",d:"M4 12a8 8 0 018-8v8z",fill:"currentColor"})]}),"Memvalidasi header..."]})]}),e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("button",{type:"button",onClick:U,className:"inline-flex items-center justify-center rounded-md border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50",disabled:k,children:[e.jsx("svg",{className:"mr-2 h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",d:"M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5 5m0 0l5-5m-5 5V3"})}),"Template"]}),e.jsxs("div",{className:"text-xs text-gray-500",children:["Header: ",ye.join(", ")]})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end",children:[e.jsx("button",{type:"button",onClick:T,disabled:k,className:"mr-2 rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50",children:"Batal"}),e.jsx("button",{type:"submit",disabled:k||!A||!!M||d,className:`inline-flex items-center rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm ${k?"cursor-not-allowed bg-blue-400":"hover:bg-blue-700"}`,children:k?"Memproses...":"Impor"})]})]})}const ke=[{title:"Siswa",href:"/students"}];function Re(){const{students:c,classrooms:H,sexes:A,statuses:x,religions:M,filters:s}=z().props,{flash:d}=z().props;l.useEffect(()=>{d!=null&&d.success&&h.success(d.success),d!=null&&d.error&&h.error(d.error)},[d]),l.useEffect(()=>{const t=r=>{F.current&&!F.current.contains(r.target)&&E(!1)};return document.addEventListener("mousedown",t),()=>{document.removeEventListener("mousedown",t)}},[]),l.useEffect(()=>{const t=s.classrooms?Array.isArray(s.classrooms)?s.classrooms.map(r=>Number(r)):[Number(s.classrooms)]:[];L(t)},[s.classrooms]);const D=s.classrooms?Array.isArray(s.classrooms)?s.classrooms.map(t=>Number(t)):[Number(s.classrooms)]:[],[k,_]=l.useState(!1),[$,T]=l.useState(!1),[R,U]=l.useState(null),[m,n]=l.useState([]),[a,g]=l.useState(null),[N,u]=l.useState(!1),[S,C]=l.useState(null),[B,I]=l.useState(""),[G,P]=l.useState(""),[f,L]=l.useState(D),[O,E]=l.useState(!1),F=l.useRef(null),j=t=>{const r=Number(t),i=f.includes(r)?f.filter(w=>w!==r):[...f,r];L(i),n([]);const b={search:s.search||void 0,sort:s.sort||void 0,direction:s.direction||void 0,status:s.status||void 0,page:1};i.length>0&&(b.classrooms=i),v.get(route("students.index"),b,{preserveState:!0,replace:!0,only:["students","filters"]})},X=()=>{L([]),n([]);const t={search:s.search||void 0,sort:s.sort||void 0,direction:s.direction||void 0,status:s.status||void 0,page:1};s.classrooms&&(t.classrooms=void 0),v.get(route("students.index"),t,{preserveState:!0,replace:!0,only:["students","filters"]})},q=(t=null)=>{U(t),_(!0)},Y=async t=>{v.delete(`/students/${t}`,{onSuccess:()=>{v.reload()}})},Z=t=>{n(r=>r.includes(t)?r.filter(i=>i!==t):[...r,t])},ee=()=>{if(m.length===0){h.error("Pilih data siswa yang akan diexport terlebih dahulu");return}const t=c.data.filter(o=>m.includes(o.id)),r=Date.now(),i=t.map(o=>{var W,J;const oe=o.date_of_birth?new Date(o.date_of_birth).toISOString().slice(0,10):"-",ne={male:"Laki-laki",female:"Perempuan"},ie={active:"Aktif",inactive:"Tidak Aktif",graduated:"Lulus"};return{"Nama Lengkap":o.full_name||"-","Orang Tua/Wali":((W=o.parent)==null?void 0:W.full_name)||"-",Kelas:((J=o.classroom)==null?void 0:J.name)||"-",NIS:{v:o.nis||"-",t:"s"},"Tahun Masuk":o.entry_year||"-","Jenis Kelamin":ne[o.gender]||o.gender,Agama:o.religion||"-","Tempat Lahir":o.birth_place||"-","Tanggal Lahir":oe,Alamat:o.address||"-",Status:ie[o.status]||o.status}}),b=K.json_to_sheet(i),w=[{width:25},{width:25},{width:15},{width:15},{width:12},{width:15},{width:15},{width:15},{width:15},{width:30},{width:12}];b["!cols"]=w;const y=K.book_new();K.book_append_sheet(y,b,"Data Siswa");const p=`${r}-data-siswa.xlsx`;try{he(y,p),h.success(`Berhasil mengekspor ${t.length} data siswa`,{description:`File: ${p}`})}catch(o){console.error("Export error:",o),h.error("Gagal mengekspor data. Silakan coba lagi.")}},te=t=>{const r=s.direction==="asc"?"desc":"asc";let i=t;t==="classroom.name"&&(i="class_name"),v.get(route("students.index"),{sort:i,direction:r,classrooms:f.length>0?f:void 0,search:s.search||void 0},{preserveState:!0})},se=async()=>{var t;if(m.length!==0)try{const r=await fetch("/bulk-kartu-siswa",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.content)||""},body:JSON.stringify({student_ids:m})});if(!r.ok)throw new Error("Gagal download file PDF");const i=await r.blob(),b=window.URL.createObjectURL(i),w=document.createElement("a");w.href=b,w.download="kumpulan-kartu-siswa.pdf",w.click()}catch{h.error("Gagal download kartu siswa.")}},ae=[{key:"profile_picture",label:"Foto",sortable:!1},{key:"full_name",label:"Nama Siswa",sortable:!0},{key:"parent.full_name",label:"Nama Orang Tua/wali",sortable:!1},{key:"classroom.name",label:"Kelas",sortable:!0},{key:"nis",label:"NIS",sortable:!0},{key:"entry_year",label:"Tahun Masuk",sortable:!0},{key:"gender",label:"Jenis Kelamin",sortable:!0},{key:"religion",label:"Agama",sortable:!0},{key:"date_of_birth",label:"Tempat, Tanggal Lahir",sortable:!0},{key:"address",label:"Alamat",sortable:!1},{key:"status",label:"Status",sortable:!0},{key:"actions",label:"Aksi",sortable:!1}],re=t=>{switch(t){case"active":return"bg-green-100 text-green-800";case"inactive":return"bg-red-100 text-red-800";case"graduated":return"bg-blue-100 text-blue-800";default:return"bg-gray-100 text-gray-800"}},le=t=>{switch(t){case"active":return"Active";case"inactive":return"Inactive";case"graduated":return"Graduated";default:return t}};return e.jsxs(fe,{breadcrumbs:ke,children:[e.jsx(ce,{title:"Siswa"}),e.jsx(ue,{position:"top-right",richColors:!0}),e.jsxs("div",{className:"flex flex-col gap-6 rounded-xl bg-white p-6 text-black shadow-lg",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"text",placeholder:"Cari siswa...",defaultValue:s.search||"",onChange:t=>{n([]),v.get(route("students.index"),{...s,search:t.target.value},{preserveState:!0})},className:"w-64 rounded border px-3 py-1 text-sm"}),e.jsxs("select",{value:s.show||"10",onChange:t=>{n([]),v.get(route("students.index"),{...s,show:t.target.value},{preserveState:!0})},className:"rounded border px-2 py-1 text-sm",children:[e.jsx("option",{value:"10",children:"Show 10 data"}),e.jsx("option",{value:"20",children:"Show 20 data"}),e.jsx("option",{value:"all",children:"Show All"})]}),e.jsxs("select",{value:s.status||"",onChange:t=>{n([]),v.get(route("students.index"),{...s,status:t.target.value},{preserveState:!0})},className:"rounded border px-2 py-1 text-sm",children:[e.jsx("option",{value:"",children:"Semua Status"}),x.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))]}),e.jsxs("div",{className:"relative",ref:F,children:[e.jsxs("button",{onClick:()=>E(!O),className:"rounded bg-gray-200 px-3 py-1 text-sm font-medium text-gray-700 hover:bg-gray-300",children:["Filter Kelas ",f.length>0?`(${f.length})`:""]}),O&&e.jsxs("div",{className:"absolute top-full left-0 z-10 mt-1 w-64 rounded-md border border-gray-200 bg-white p-3 shadow-lg",children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium",children:"Filter by Kelas"}),f.length>0&&e.jsx("button",{onClick:X,className:"text-xs text-blue-600 hover:text-blue-800",children:"Clear"})]}),e.jsx("div",{className:"max-h-48 overflow-y-auto",children:H.map(t=>e.jsxs("label",{className:"flex items-center space-x-2 py-1",children:[e.jsx("input",{type:"checkbox",checked:f.includes(t.id),onChange:()=>j(t.id),className:"rounded border-gray-300"}),e.jsx("span",{className:"text-sm",children:t.name})]},t.id))})]})]}),e.jsx("button",{disabled:m.length===0||c.data.length===0,onClick:ee,className:`rounded bg-indigo-600 px-3 py-1 text-sm font-medium text-white transition ${m.length===0||c.data.length===0?"cursor-not-allowed opacity-50":"hover:cursor-pointer hover:bg-indigo-700"}`,children:"Ekspor Data"}),e.jsx("button",{disabled:m.length===0||c.data.length===0,onClick:se,className:`rounded bg-indigo-700 px-3 py-1 text-sm font-medium text-white transition ${m.length===0||c.data.length===0?"cursor-not-allowed opacity-50":"hover:cursor-pointer hover:bg-indigo-700"}`,children:"Print Kartu"}),e.jsxs("button",{onClick:()=>T(!0),className:"flex items-center gap-2 rounded bg-blue-600 px-3 py-1 text-sm font-medium text-white hover:bg-blue-700",children:[e.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5-5 5 5M12 5v14"})}),e.jsx("span",{children:"Impor Data"})]})]}),e.jsx("button",{onClick:()=>q(null),className:"rounded bg-green-600 px-3 py-1 text-sm font-medium text-white transition hover:cursor-pointer hover:bg-green-700",children:"Tambah Siswa"})]}),e.jsx(ge,{headers:ae,data:c.data,sortColumn:s.sort??"",sortDirection:s.direction==="asc"||s.direction==="desc"?s.direction:"asc",onSort:te,onSelectAll:t=>n(t?c.data.map(r=>r.id):[]),selectedIds:m,rowRender:t=>{var r,i,b,w;return e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"w-[10px] p-3 text-sm",children:e.jsx("input",{type:"checkbox",checked:m.includes(t.id),onChange:()=>Z(t.id)})}),e.jsx("td",{className:"p-3",children:e.jsx("div",{className:"flex justify-center",children:t.profile_picture?e.jsx("img",{src:`/storage/${t.profile_picture}`,alt:t.full_name,className:"h-10 w-10 rounded-full border border-gray-300 object-cover"}):e.jsx("img",{src:`https://api.dicebear.com/9.x/initials/svg?seed=${encodeURIComponent(t.full_name)}`,alt:t.full_name,className:"h-10 w-10 rounded-full border border-gray-300 object-cover"})})}),e.jsx("td",{className:"p-3 text-sm",children:t.full_name}),e.jsx("td",{className:"p-3 text-sm",children:((r=t.parent)==null?void 0:r.full_name)||"-"}),e.jsx("td",{className:"p-3 text-sm",children:((i=t.classroom)==null?void 0:i.name)||"-"}),e.jsx("td",{className:"p-3 text-sm",children:t.nis||"-"}),e.jsx("td",{className:"p-3 text-sm",children:t.entry_year}),e.jsx("td",{className:"p-3 text-sm",children:t.gender}),e.jsx("td",{className:"p-3 text-sm",children:t.religion||"-"}),e.jsx("td",{className:"p-3 text-sm",children:(()=>{const y=t.birth_place,p=t.date_of_birth;return y&&p?`${y}, ${p}`:y||p||"-"})()}),e.jsx("td",{className:"p-3 text-sm",children:t.address?t.address.length>70?t.address.substring(0,70)+"...":t.address:"-"}),e.jsx("td",{className:"p-3 text-sm",children:e.jsx("span",{className:`inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${re(t.status)}`,children:le(t.status)})}),e.jsxs("td",{className:"flex justify-center gap-2 p-3",children:[e.jsx("button",{onClick:()=>q(t),className:"rounded bg-blue-500 px-3 py-1 text-sm font-medium text-white hover:cursor-pointer",children:"Edit"}),e.jsx(de,{href:route("students.attendance",t.id),className:`rounded px-3 py-1 text-sm font-medium text-white ${(b=t.classroom)!=null&&b.name?"bg-sky-500 hover:cursor-pointer hover:bg-sky-600":"cursor-not-allowed bg-sky-300"}`,onClick:y=>{var p;(p=t.classroom)!=null&&p.name||y.preventDefault()},title:(w=t.classroom)!=null&&w.name?"":"Siswa harus memiliki kelas untuk melihat kehadiran",children:"Kehadiran"}),e.jsx("button",{onClick:async()=>{C(t),u(!0);const p=await(await fetch(route("student.qrcode.preview",{student:t.id}))).text();P(p),I(route("kartu-siswa",{student_id:t.id}))},className:"rounded bg-sky-500 px-3 py-1 text-sm font-medium text-white hover:cursor-pointer",children:"Kartu"}),e.jsx("button",{onClick:()=>g(t),className:"rounded bg-red-500 px-3 py-1 text-sm font-medium text-white hover:cursor-pointer",children:"Hapus"})]})]},t.id)}}),e.jsx(xe,{links:c.links}),e.jsx(be,{isOpen:k,onClose:()=>_(!1),student:R,classrooms:H,sexes:A,statuses:x,religions:M}),e.jsx(Q,{isOpen:!!a,onClose:()=>g(null),title:"Konfirmasi Penghapusan",message:e.jsxs("span",{children:["Apakah Anda yakin ingin menghapus siswa ",e.jsx("strong",{children:a==null?void 0:a.full_name}),"?"]}),buttons:[{label:"Batal",onClick:()=>g(null),variant:"neutral"},{label:"Ya, Hapus",onClick:()=>{a&&(Y(a.id),g(null))},variant:"danger"}]}),e.jsx(Q,{isOpen:N,onClose:()=>{u(!1),C(null),P(""),I("")},title:`Kartu Pelajar - ${S==null?void 0:S.full_name}`,message:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx("div",{dangerouslySetInnerHTML:{__html:G},className:"h-[200px] w-[200px]"}),e.jsx("a",{href:B,download:!0,className:"mt-2 rounded bg-blue-600 px-4 py-2 text-sm text-white hover:bg-blue-700",children:"Download PDF"})]}),buttons:[{label:"Close",onClick:()=>u(!1),variant:"neutral"}]})]}),e.jsx(ve,{isOpen:$,onClose:()=>T(!1)})]})}export{Re as default};
