import{r as o,j as e,a as w,u as z,H as ie,L as ce}from"./app-DCW8ZbIn.js";import{A as Q}from"./action-modal-CPofCLvh.js";import{F as de}from"./form-modal-BOokFLum.js";import{t as b,T as me}from"./index-dniJif3s.js";import{r as ue,u as pe}from"./xlsx-BUW7exb-.js";import{P as xe}from"./pagination-B75g8JXx.js";import{T as he}from"./table-BzDfGLDB.js";import{A as fe}from"./app-layout-BXOrTjp8.js";import ge from"./form-NRixiEN8.js";/* empty css            */import"./proxy-C_vF132w.js";import"./index-D8ZYbZWL.js";import"./createLucideIcon-D9Xw8cPb.js";import"./button-Dn8B2PMD.js";import"./index-C54Aqz14.js";import"./index-DH_UA2EO.js";import"./app-logo-icon-CEARzicn.js";import"./searchable-select-uBR5fuSu.js";const V=["nama_lengkap","nama_orang_tua","kelas","nis","tahun_masuk","jenis_kelamin","status","agama","tempat_lahir","tanggal_lahir","alamat"],J=y=>y.replace(/\*/g,"").trim().toLowerCase().replace(/\s+/g,"_");function be({isOpen:y,onClose:D}){const[L,h]=o.useState(null),[O,s]=o.useState(""),[i,M]=o.useState(!1),[f,S]=o.useState(!1),A=()=>{h(null),s(""),M(!1),S(!1)},C=()=>{f||(A(),D())},E=d=>{var m;s("");const r=((m=d.target.files)==null?void 0:m[0])??null;if(!r){h(null);return}if(r.size>2*1024*1024){s("Ukuran file maksimal 2MB"),h(null);return}const p=["application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/csv"];if(r.type&&!p.includes(r.type)){s("Tipe file tidak didukung. Upload .xlsx / .xls"),h(null);return}M(!0);const j=new FileReader;j.onload=v=>{var k;try{const U=(k=v.target)==null?void 0:k.result,T=ue(U,{type:"array"}),P=T.SheetNames[0],I=T.Sheets[P],_=(pe.sheet_to_json(I,{header:1})[0]||[]).map(N=>J(String(N??""))),$=V.map(J);_.length===$.length&&$.every((N,H)=>N===_[H])?(h(r),b.success("File valid. Siap diimpor.")):(s("Header file tidak sesuai template."),h(null))}catch{s("Gagal membaca file. Format Excel tidak valid."),h(null)}finally{M(!1)}},j.readAsArrayBuffer(r)},R=async()=>{var d;try{const r=await fetch(route("students.template"),{method:"GET"});if(!r.ok){const k=((d=await r.json().catch(()=>null))==null?void 0:d.message)||"Gagal mengunduh template";b.error(k);return}const p=await r.blob(),j=window.URL.createObjectURL(p),m=document.createElement("a"),v=r.headers.get("X-File-Name")||"template-import-siswa.xlsx";m.href=j,m.download=v,document.body.appendChild(m),m.click(),m.remove(),window.URL.revokeObjectURL(j),b.success("Template siswa berhasil diunduh")}catch{b.error("Terjadi kesalahan saat mengunduh template")}},c=()=>{if(!L){s("Pilih file terlebih dahulu");return}S(!0);const d=new FormData;d.append("file",L),w.post(route("students.import"),d,{onSuccess:()=>{C(),w.reload()},onError:r=>{const p=(r==null?void 0:r.file)||"Import gagal. Periksa isi file.";b.error(p)},onFinish:()=>S(!1),preserveScroll:!0})};return e.jsxs(de,{isOpen:y,onClose:C,title:"Import Data Siswa",onSubmit:d=>{d.preventDefault(),c()},children:[e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{className:"rounded-lg border border-dashed border-gray-300 p-4",children:[e.jsx("label",{className:"mb-2 block text-sm font-medium text-gray-700",children:"Upload File (.xlsx / .xls)"}),e.jsx("input",{type:"file",accept:".xlsx,.xls,.csv",onChange:E,disabled:f,className:"block w-full text-sm text-gray-500 file:mr-4 file:rounded-md file:border-0 file:bg-blue-50 file:px-4 file:py-2.5 file:text-sm file:font-medium file:text-blue-700 hover:file:bg-blue-100"}),e.jsx("p",{className:"mt-2 text-xs text-gray-500",children:"Gunakan template agar header sesuai. Maks 2MB."}),O&&e.jsx("div",{className:"mt-2 text-xs text-red-600",children:O}),i&&e.jsxs("div",{className:"mt-2 inline-flex items-center text-xs text-gray-600",children:[e.jsxs("svg",{className:"mr-1.5 h-3.5 w-3.5 animate-spin",viewBox:"0 0 24 24",fill:"none",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor"}),e.jsx("path",{className:"opacity-75",d:"M4 12a8 8 0 018-8v8z",fill:"currentColor"})]}),"Memvalidasi header..."]})]}),e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("button",{type:"button",onClick:R,className:"inline-flex items-center justify-center rounded-md border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50",disabled:f,children:[e.jsx("svg",{className:"mr-2 h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",d:"M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5 5m0 0l5-5m-5 5V3"})}),"Template"]}),e.jsxs("div",{className:"text-xs text-gray-500",children:["Header: ",V.join(", ")]})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end",children:[e.jsx("button",{type:"button",onClick:C,disabled:f,className:"mr-2 rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50",children:"Batal"}),e.jsx("button",{type:"submit",disabled:f||!L||!!O||i,className:`inline-flex items-center rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm ${f?"cursor-not-allowed bg-blue-400":"hover:bg-blue-700"}`,children:f?"Memproses...":"Impor"})]})]})}const ye=[{title:"Siswa",href:"/students"}];function Re(){const{students:y,classrooms:D,sexes:L,statuses:h,religions:O,filters:s}=z().props,{flash:i}=z().props;o.useEffect(()=>{i!=null&&i.success&&b.success(i.success),i!=null&&i.error&&b.error(i.error)},[i]),o.useEffect(()=>{const t=a=>{N.current&&!N.current.contains(a.target)&&B(!1)};return document.addEventListener("mousedown",t),()=>{document.removeEventListener("mousedown",t)}},[]),o.useEffect(()=>{const t=s.classrooms?Array.isArray(s.classrooms)?s.classrooms.map(a=>Number(a)):[Number(s.classrooms)]:[];_(t)},[s.classrooms]);const M=s.classrooms?Array.isArray(s.classrooms)?s.classrooms.map(t=>Number(t)):[Number(s.classrooms)]:[],[f,S]=o.useState(!1),[A,C]=o.useState(!1),[E,R]=o.useState(null),[c,d]=o.useState([]),[r,p]=o.useState(null),[j,m]=o.useState(!1),[v,k]=o.useState(null),[U,T]=o.useState(""),[P,I]=o.useState(""),[x,_]=o.useState(M),[$,B]=o.useState(!1),N=o.useRef(null),H=t=>{const a=Number(t),n=x.includes(a)?x.filter(u=>u!==a):[...x,a];_(n);const g={search:s.search||void 0,sort:s.sort||void 0,direction:s.direction||void 0,page:1};n.length>0&&(g.classrooms=n),w.get(route("students.index"),g,{preserveState:!0,replace:!0,only:["students","filters"]})},W=()=>{_([]);const t={search:s.search||void 0,sort:s.sort||void 0,direction:s.direction||void 0,page:1};s.classrooms&&(t.classrooms=void 0),w.get(route("students.index"),t,{preserveState:!0,replace:!0,only:["students","filters"]})},K=(t=null)=>{R(t),S(!0)},X=async t=>{w.delete(`/students/${t}`,{onSuccess:()=>{w.reload()}})},Y=t=>{d(a=>a.includes(t)?a.filter(n=>n!==t):[...a,t])},Z=()=>{if(c.length===0)return;const t=y.data.filter(l=>c.includes(l.id)),a=`Nama Siswa,Nama Orang Tua/Wali,Kelas,NIS,Tahun Masuk,Jenis Kelamin,Agama,Tanggal Lahir,Alamat,Status
`,n=t.map(l=>{var q,G;const le=l.address?`"${l.address.replace(/[\r\n\u2028\u2029\u0085]+/g," ").replace(/"/g,'""')}"`:'""',oe=l.date_of_birth?new Date(l.date_of_birth).toISOString().slice(0,10):"",ne=l.nis?l.nis:"-";return`${l.full_name},${(q=l.parent)==null?void 0:q.full_name},${(G=l.classroom)==null?void 0:G.name},${ne},${l.entry_year},${l.gender},${l.religion},${oe},${le},${l.status}`}).join(`
`),g=new Blob([a,n],{type:"text/csv"}),u=URL.createObjectURL(g),F=document.createElement("a");F.href=u,F.download="students.csv",F.click(),b.success(`Berhasil mengekspor ${c.length} data siswa`,{description:"File CSV telah didownload otomatis"}),URL.revokeObjectURL(u)},ee=t=>{const a=s.direction==="asc"?"desc":"asc";let n=t;t==="classroom.name"&&(n="class_name"),w.get(route("students.index"),{sort:n,direction:a,classrooms:x.length>0?x:void 0,search:s.search||void 0},{preserveState:!0})},te=async()=>{var t;if(c.length!==0)try{const a=await fetch("/bulk-kartu-siswa",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.content)||""},body:JSON.stringify({student_ids:c})});if(!a.ok)throw new Error("Failed to download PDF");const n=await a.blob(),g=window.URL.createObjectURL(n),u=document.createElement("a");u.href=g,u.download="kumpulan-kartu-siswa.pdf",u.click()}catch{b.error("Gagal download kartu siswa.")}},se=[{key:"profile_picture",label:"Foto",sortable:!1},{key:"full_name",label:"Nama Siswa",sortable:!0},{key:"parent.full_name",label:"Nama Orang Tua/wali",sortable:!1},{key:"classroom.name",label:"Kelas",sortable:!0},{key:"nis",label:"NIS",sortable:!0},{key:"entry_year",label:"Tahun Masuk",sortable:!0},{key:"gender",label:"Jenis Kelamin",sortable:!0},{key:"religion",label:"Agama",sortable:!0},{key:"date_of_birth",label:"Tanggal Lahir",sortable:!0},{key:"address",label:"Alamat",sortable:!1},{key:"status",label:"Status",sortable:!0},{key:"actions",label:"Aksi",sortable:!1}],ae=t=>{switch(t){case"active":return"bg-green-100 text-green-800";case"inactive":return"bg-red-100 text-red-800";case"graduated":return"bg-blue-100 text-blue-800";default:return"bg-gray-100 text-gray-800"}},re=t=>{switch(t){case"active":return"Active";case"inactive":return"Inactive";case"graduated":return"Graduated";default:return t}};return e.jsxs(fe,{breadcrumbs:ye,children:[e.jsx(ie,{title:"Siswa"}),e.jsx(me,{position:"top-right",richColors:!0}),e.jsxs("div",{className:"flex flex-col gap-6 rounded-xl bg-white p-6 text-black shadow-lg",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"text",placeholder:"Cari siswa...",defaultValue:s.search||"",onChange:t=>w.get(route("students.index"),{search:t.target.value},{preserveState:!0}),className:"w-64 rounded border px-3 py-1"}),e.jsxs("div",{className:"relative",ref:N,children:[e.jsxs("button",{onClick:()=>B(!$),className:"rounded bg-gray-200 px-3 py-1 text-sm font-medium text-gray-700 hover:bg-gray-300",children:["Filter Kelas ",x.length>0?`(${x.length})`:""]}),$&&e.jsxs("div",{className:"absolute top-full left-0 z-10 mt-1 w-64 rounded-md border border-gray-200 bg-white p-3 shadow-lg",children:[e.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium",children:"Filter by Kelas"}),x.length>0&&e.jsx("button",{onClick:W,className:"text-xs text-blue-600 hover:text-blue-800",children:"Clear"})]}),e.jsx("div",{className:"max-h-48 overflow-y-auto",children:D.map(t=>e.jsxs("label",{className:"flex items-center space-x-2 py-1",children:[e.jsx("input",{type:"checkbox",checked:x.includes(t.id),onChange:()=>H(t.id),className:"rounded border-gray-300"}),e.jsx("span",{className:"text-sm",children:t.name})]},t.id))})]})]}),e.jsx("button",{disabled:c.length===0,onClick:Z,className:`rounded bg-indigo-600 px-3 py-1 text-sm font-medium text-white hover:bg-indigo-700 ${c.length===0?"cursor-not-allowed opacity-50":"hover:cursor-pointer"}`,children:"Ekspor data yang dipilih"}),e.jsx("button",{disabled:c.length===0,onClick:te,className:"rounded bg-indigo-700 px-3 py-1 text-sm font-medium text-white hover:bg-indigo-700 disabled:cursor-not-allowed disabled:opacity-50",children:"Bulk Print Kartu Siswa"}),e.jsxs("button",{onClick:()=>C(!0),className:"rounded bg-indigo-600 px-3 py-1 text-sm font-medium text-white hover:bg-indigo-700",children:[e.jsx("svg",{className:"mr-2 h-4 w-4",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5-5 5 5M12 5v14"})}),"Impor Data"]})]}),e.jsx("button",{onClick:()=>K(null),className:"rounded bg-green-600 px-3 py-1 text-sm font-medium text-white transition hover:cursor-pointer hover:bg-green-700",children:"Tambah Siswa"})]}),e.jsx(he,{headers:se,data:y.data,sortColumn:s.sort??"",sortDirection:s.direction==="asc"||s.direction==="desc"?s.direction:"asc",onSort:ee,onSelectAll:t=>d(t?y.data.map(a=>a.id):[]),selectedIds:c,rowRender:t=>{var a,n,g,u;return e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"w-[10px] p-3 text-sm",children:e.jsx("input",{type:"checkbox",checked:c.includes(t.id),onChange:()=>Y(t.id)})}),e.jsx("td",{className:"p-3",children:e.jsx("div",{className:"flex justify-center",children:t.profile_picture?e.jsx("img",{src:`/storage/${t.profile_picture}`,alt:t.full_name,className:"h-10 w-10 rounded-full border border-gray-300 object-cover"}):e.jsx("img",{src:`https://api.dicebear.com/9.x/initials/svg?seed=${encodeURIComponent(t.full_name)}`,alt:t.full_name,className:"h-10 w-10 rounded-full border border-gray-300 object-cover"})})}),e.jsx("td",{className:"p-3 text-sm",children:t.full_name}),e.jsx("td",{className:"p-3 text-sm",children:((a=t.parent)==null?void 0:a.full_name)||"-"}),e.jsx("td",{className:"p-3 text-sm",children:((n=t.classroom)==null?void 0:n.name)||"-"}),e.jsx("td",{className:"p-3 text-sm",children:t.nis||"-"}),e.jsx("td",{className:"p-3 text-sm",children:t.entry_year}),e.jsx("td",{className:"p-3 text-sm",children:t.gender}),e.jsx("td",{className:"p-3 text-sm",children:t.religion}),e.jsxs("td",{className:"p-3 text-sm",children:[t.birth_place,", ",t.date_of_birth]}),e.jsx("td",{className:"p-3 text-sm",children:t.address?t.address.length>70?t.address.substring(0,70)+"...":t.address:"-"}),e.jsx("td",{className:"p-3 text-sm",children:e.jsx("span",{className:`inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${ae(t.status)}`,children:re(t.status)})}),e.jsxs("td",{className:"flex justify-center gap-2 p-3",children:[e.jsx("button",{onClick:()=>K(t),className:"rounded bg-blue-500 px-3 py-1 text-sm font-medium text-white hover:cursor-pointer",children:"Edit"}),e.jsx(ce,{href:route("students.attendance",t.id),className:`rounded px-3 py-1 text-sm font-medium text-white ${(g=t.classroom)!=null&&g.name?"bg-sky-500 hover:cursor-pointer hover:bg-sky-600":"cursor-not-allowed bg-sky-300"}`,onClick:F=>{var l;(l=t.classroom)!=null&&l.name||F.preventDefault()},title:(u=t.classroom)!=null&&u.name?"":"Siswa harus memiliki kelas untuk melihat kehadiran",children:"Kehadiran"}),e.jsx("button",{onClick:async()=>{k(t),m(!0);const l=await(await fetch(route("student.qrcode.preview",{student:t.id}))).text();I(l),T(route("kartu-siswa",{student_id:t.id}))},className:"rounded bg-sky-500 px-3 py-1 text-sm font-medium text-white hover:cursor-pointer",children:"Kartu"}),e.jsx("button",{onClick:()=>p(t),className:"rounded bg-red-500 px-3 py-1 text-sm font-medium text-white hover:cursor-pointer",children:"Hapus"})]})]},t.id)}}),e.jsx(xe,{links:y.links}),e.jsx(ge,{isOpen:f,onClose:()=>S(!1),student:E,classrooms:D,sexes:L,statuses:h,religions:O}),e.jsx(Q,{isOpen:!!r,onClose:()=>p(null),title:"Confirm Deletion",message:e.jsxs("span",{children:["Are you sure you want to delete student ",e.jsx("strong",{children:r==null?void 0:r.full_name}),"?"]}),buttons:[{label:"Cancel",onClick:()=>p(null),variant:"neutral"},{label:"Delete",onClick:()=>{r&&(X(r.id),p(null))},variant:"danger"}]}),e.jsx(Q,{isOpen:j,onClose:()=>{m(!1),k(null),I(""),T("")},title:`Kartu Pelajar - ${v==null?void 0:v.full_name}`,message:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx("div",{dangerouslySetInnerHTML:{__html:P},className:"h-[200px] w-[200px]"}),e.jsx("a",{href:U,download:!0,className:"mt-2 rounded bg-blue-600 px-4 py-2 text-sm text-white hover:bg-blue-700",children:"Download PDF"})]}),buttons:[{label:"Close",onClick:()=>m(!1),variant:"neutral"}]})]}),e.jsx(be,{isOpen:A,onClose:()=>C(!1)})]})}export{Re as default};
