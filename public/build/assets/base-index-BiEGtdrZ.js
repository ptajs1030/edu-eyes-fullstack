import{r as i,j as e,a as k,u as W,H as z}from"./app-B60Ir9-g.js";import{A as G}from"./action-modal-CtUY_-MH.js";import{F as J}from"./form-modal-DnOqLXe8.js";import{t as m,T as K}from"./index-C5HPMRWI.js";import{r as X,u as q}from"./xlsx-BUW7exb-.js";import{P as Q}from"./pagination-BakV3XZz.js";import{T as Y}from"./table-OUh-P9Bq.js";import{A as Z}from"./app-layout-B2102eE_.js";import ee from"./base-form-DZhQlOfl.js";import"./proxy-BVwraoBL.js";import"./index-DZM0C37h.js";import"./createLucideIcon-zq_0DlfB.js";import"./button-boDlnleG.js";import"./index-FigAG3W4.js";import"./index-txkcEbAQ.js";import"./app-logo-icon-BUU8rQ6c.js";const te=o=>{switch(o){case"parent":return["full_name","username","email","phone","address","password","status","job"];case"teacher":return["full_name","username","email","phone","address","password","status","nip","position"];default:return["parent","classroom","full_name","nis","entry_year","gender","status","religion","birth_place","date_of_birth","address"]}},se=o=>{switch(o){case"parent":return["full_name","username","email","phone","address","password","status","job"];case"teacher":return["full_name","username","email","phone","address","password","status","nip","position"];default:return["parent","classroom","full_name","nis","entry_year","gender","status","religion","birth_place","date_of_birth","address"]}},V=o=>o.replace(/\*/g,"").trim().toLowerCase().replace(/\s+/g,"_");function ae({isOpen:o,onClose:I,role:n,routePrefix:A}){const[S,s]=i.useState(null),[u,b]=i.useState(""),[_,N]=i.useState(!1),[c,d]=i.useState(!1),B=()=>{s(null),b(""),N(!1),d(!1)},p=()=>{c||(B(),I())},R=h=>{var x;b("");const a=((x=h.target.files)==null?void 0:x[0])??null;if(!a){s(null);return}const y=["application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/csv"];if(a.type&&!y.includes(a.type)){b("Tipe file tidak didukung. Harap upload .xlsx / .xls"),s(null);return}N(!0);const f=new FileReader;f.onload=l=>{var w;try{const $=(w=l.target)==null?void 0:w.result,E=X($,{type:"array"}),L=E.SheetNames[0],O=E.Sheets[L],M=(q.sheet_to_json(O,{header:1})[0]||[]).map(t=>V(String(t??""))),T=te(n.value).map(V);M.length===T.length&&T.every((t,r)=>t===M[r])?(s(a),m.success("File valid. Siap di-import.")):(b("Header file tidak sesuai template. Gunakan template terbaru."),s(null))}catch{b("Gagal membaca file. Pastikan format Excel valid."),s(null)}finally{N(!1)}},f.readAsArrayBuffer(a)},g=async()=>{var h;try{const a=await fetch(route("users.template",n.value),{method:"GET"});if(!a.ok){const w=((h=await a.json().catch(()=>null))==null?void 0:h.message)||"Gagal mengunduh template";m.error(w);return}const y=await a.blob(),f=window.URL.createObjectURL(y),x=document.createElement("a"),l=a.headers.get("X-File-Name")||`template-import-${n.value}.xlsx`;x.href=f,x.download=l,document.body.appendChild(x),x.click(),x.remove(),window.URL.revokeObjectURL(f),m.success(`Template ${n.name} berhasil diunduh`)}catch{m.error("Terjadi kesalahan saat mengunduh template")}},C=()=>{if(!S){b("Pilih file terlebih dahulu");return}d(!0);const h=new FormData;h.append("file",S),k.post(route(`${A}.import`),h,{onStart:()=>d(!0),onSuccess:()=>{d(!1),p(),k.reload()},onError:a=>{const y=(a==null?void 0:a.file)||"Import gagal. Periksa isi file.";m.error(y),d(!1)},onFinish:()=>d(!1),headers:{"Content-Type":"multipart/form-data"},preserveScroll:!0})};return e.jsxs(J,{isOpen:o,onClose:p,title:`Import Data ${n.name}`,onSubmit:h=>{h.preventDefault(),C()},children:[e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{className:"rounded-lg border border-dashed border-gray-300 p-4",children:[e.jsx("label",{className:"mb-2 block text-sm font-medium text-gray-700",children:"Upload File (.xlsx / .xls)"}),e.jsx("div",{className:"relative mt-1",children:e.jsx("input",{type:"file",accept:".xlsx,.xls,.csv",onChange:R,disabled:c,className:"block w-full text-sm text-gray-500 file:mr-4 file:rounded-md file:border-0 file:bg-blue-50 file:px-4 file:py-2.5 file:text-sm file:font-medium file:text-blue-700 hover:file:bg-blue-100"})}),e.jsx("p",{className:"mt-2 text-xs text-gray-500",children:"Gunakan template agar header sesuai. Maks 2MB."}),u&&e.jsx("div",{className:"mt-2 text-xs text-red-600",children:u}),_&&e.jsxs("div",{className:"mt-2 inline-flex items-center text-xs text-gray-600",children:[e.jsxs("svg",{className:"mr-1.5 h-3.5 w-3.5 animate-spin",viewBox:"0 0 24 24",fill:"none",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor"}),e.jsx("path",{className:"opacity-75",d:"M4 12a8 8 0 018-8v8z",fill:"currentColor"})]}),"Memvalidasi header..."]})]}),e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("button",{type:"button",onClick:g,className:"inline-flex items-center justify-center rounded-md border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm hover:cursor-pointer hover:bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:outline-none",disabled:c,children:[e.jsx("svg",{className:"mr-2 h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",d:"M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5 5m0 0l5-5m-5 5V3"})}),"Template"]}),e.jsxs("div",{className:"text-xs text-gray-500",children:["Header: ",se(n.value).join(", ")]})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end",children:[e.jsx("button",{type:"button",onClick:p,disabled:c,className:"mr-2 rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:cursor-pointer hover:bg-gray-50",children:"Batal"}),e.jsxs("button",{type:"submit",disabled:c||!S||!!u||_,className:`inline-flex items-center rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm ${c?"cursor-not-allowed bg-blue-400":"bg-blue-600 hover:cursor-pointer hover:bg-blue-700"}`,children:[c&&e.jsxs("svg",{className:"mr-2 h-4 w-4 animate-spin",viewBox:"0 0 24 24",fill:"none",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor"}),e.jsx("path",{className:"opacity-75",d:"M4 12a8 8 0 018-8v8z",fill:"currentColor"})]}),c?"Memproses...":"Impor"]})]})]})}function je({users:o,statuses:I,filters:n,breadcrumbs:A,title:S,role:s,routePrefix:u}){const[b,_]=i.useState(!1),[N,c]=i.useState(!1),[d,B]=i.useState(null),[p,R]=i.useState([]),[g,C]=i.useState(null),[h,a]=i.useState(null),[y,f]=i.useState(!1),x=async t=>{if(!t.phone){a(t),f(!0);return}k.put(route(`${u}.reset-password`,t.id),{},{onSuccess:()=>{var F;const r=encodeURIComponent("Password akun EduEyes Anda telah direset. Password baru: eduEyes123");let v=((F=t.phone)==null?void 0:F.replace(/[^0-9]/g,""))||"";v.startsWith("08")&&(v="628"+v.slice(2));const P=`https://wa.me/${v}?text=${r}`;window.open(P,"_blank"),m.success("Password berhasil direset dan link WA telah dibuka")},onError:r=>{console.log(r),m.error("Gagal reset password")}})},{flash:l}=W().props;i.useEffect(()=>{l!=null&&l.success&&m.success(l.success),l!=null&&l.error&&m.error(l.error)},[l]);const w=(t=null)=>{B(t),_(!0)},$=t=>{k.delete(route(`${u}.destroy`,t),{onSuccess:()=>{k.reload()},onError:()=>{m.error("Failed to delete user")}})},E=t=>{R(r=>r.includes(t)?r.filter(v=>v!==t):[...r,t])},L=()=>{if(p.length===0)return;const t=o.data.filter(j=>p.includes(j.id)),r=`Name,Username,Role,Phone,Email,Status
`,v=t.map(j=>`${j.full_name},${j.username},${j.role.name},${j.phone},${j.email},${j.status}`).join(`
`),P=new Blob([r,v],{type:"text/csv"}),F=URL.createObjectURL(P),U=document.createElement("a");U.href=F,U.download=`${s.value}-users.csv`,U.click(),m.success(`Berhasil mengekspor ${t.length} data user`,{description:"File CSV telah didownload otomatis"})},O=t=>{k.get(route(`${u}.index`),{sort:t,direction:n.direction==="asc"?"desc":"asc"},{preserveState:!0})},D=[...s.value==="admin"||s.value==="teacher"?[{key:"profile_picture",label:"Foto",sortable:!1}]:[],{key:"full_name",label:"Nama",sortable:!0},...s.value==="admin"||s.value==="teacher"?[{key:"nip",label:"NIP",sortable:!0}]:[],{key:"username",label:"Username",sortable:!0},...s.value==="admin"||s.value==="teacher"?[{key:"position",label:"Jabatan",sortable:!0}]:[{key:"job",label:"Pekerjaan",sortable:!0}],{key:"phone",label:"Nomor Telepon",sortable:!0},{key:"email",label:"Email",sortable:!0},{key:"status",label:"Status",sortable:!0},{key:"address",label:"Alamat",sortable:!0},{key:"actions",label:"Aksi",sortable:!1}],M=t=>{switch(t){case"active":return"bg-green-100 text-green-800";case"inactive":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}},T=t=>{switch(t){case"active":return"Active";case"inactive":return"Inactive";default:return t}},H=t=>({Admin:"Admin",Teacher:"Guru",Parent:"Orang Tua"})[t]||t;return e.jsxs(Z,{breadcrumbs:A,children:[e.jsx(z,{title:S}),e.jsx(K,{position:"top-right",richColors:!0}),e.jsxs("div",{className:"flex flex-col gap-6 rounded-xl bg-white p-6 text-black shadow-lg",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"text",placeholder:"Cari pengguna...",defaultValue:n.search||"",onChange:t=>k.get(route(`${u}.index`),{search:t.target.value},{preserveState:!0}),className:"w-64 rounded border px-3 py-1"}),e.jsx("button",{disabled:p.length===0,onClick:L,className:`rounded bg-indigo-600 px-3 py-1 text-sm font-medium text-white hover:bg-indigo-700 ${p.length===0?"cursor-not-allowed opacity-50":"hover:cursor-pointer"}`,children:"Ekspor data yang dipilih"}),e.jsxs("button",{onClick:()=>c(!0),className:"inline-flex items-center rounded bg-indigo-600 px-3 py-1 text-sm font-medium text-white hover:cursor-pointer hhover:bg-indigo-700",children:[e.jsx("svg",{className:"mr-2 h-4 w-4",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5-5 5 5M12 5v14"})}),"Impor Data"]})]}),e.jsxs("button",{onClick:()=>w(null),className:"rounded bg-green-600 px-3 py-1 text-sm font-medium text-white transition hover:cursor-pointer hover:bg-green-700",children:["Tambah ",H(s.name)]})]}),e.jsx(Y,{headers:D,data:o.data,sortColumn:n.sort??"",sortDirection:n.direction==="asc"||n.direction==="desc"?n.direction:"asc",onSort:O,onSelectAll:t=>R(t?o.data.map(r=>r.id):[]),selectedIds:p,rowRender:t=>e.jsxs("tr",{className:"border-b",children:[e.jsx("td",{className:"w-[10px] p-3 text-sm",children:e.jsx("input",{type:"checkbox",checked:p.includes(t.id),onChange:()=>E(t.id)})}),(s.value==="admin"||s.value==="teacher")&&e.jsx("td",{className:"w-[50px] p-3 text-sm",children:e.jsx("div",{className:"h-10 w-10 overflow-hidden rounded-full border shadow-sm",children:e.jsx("img",{src:t.profile_picture?`/storage/${t.profile_picture}`:`https://api.dicebear.com/9.x/initials/svg?seed=${encodeURIComponent(t.full_name)}`,alt:t.full_name,className:"h-full w-full object-cover"})})}),e.jsx("td",{className:"p-3 text-sm",children:t.full_name}),(s.value==="admin"||s.value==="teacher")&&e.jsx("td",{className:"p-3 text-sm",children:t.nip||"-"}),e.jsx("td",{className:"p-3 text-sm",children:t.username}),(s.value==="admin"||s.value==="teacher")&&e.jsx("td",{className:"p-3 text-sm",children:t.position||"-"}),s.value==="parent"&&e.jsx("td",{className:"p-3 text-sm",children:t.job||"-"}),e.jsx("td",{className:"p-3 text-sm",children:t.phone||"-"}),e.jsx("td",{className:"p-3 text-sm",children:t.email||"-"}),e.jsx("td",{className:"p-3 text-sm",children:e.jsx("span",{className:`inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${M(t.status)}`,children:T(t.status)})}),e.jsx("td",{className:"p-3 text-sm",children:t.address?t.address.length>70?t.address.substring(0,70)+"...":t.address:"-"}),e.jsx("td",{className:"p-3 text-sm",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>w(t),className:"rounded bg-blue-500 px-3 py-1 font-medium text-white hover:cursor-pointer",children:"Edit"}),e.jsx("button",{onClick:()=>C(t),className:"rounded bg-red-500 px-3 py-1 font-medium text-white hover:cursor-pointer",children:"Hapus"}),e.jsx("button",{onClick:()=>x(t),className:"rounded bg-yellow-500 px-5 py-1 font-medium whitespace-nowrap text-white hover:cursor-pointer",children:"Reset Password"})]})})]},t.id)}),e.jsx(Q,{links:o.links}),e.jsx(ee,{isOpen:b,onClose:()=>_(!1),user:d,statuses:I,role:s,routePrefix:u},(d==null?void 0:d.id)||"new"),e.jsx(G,{isOpen:!!g,onClose:()=>C(null),title:"Confirm Deletion",message:e.jsxs("span",{children:["Are you sure you want to delete user ",e.jsx("strong",{children:g==null?void 0:g.full_name}),"?"]}),buttons:[{label:"Cancel",onClick:()=>C(null),variant:"neutral"},{label:"Delete",onClick:()=>{g&&($(g.id),C(null))},variant:"danger"}]}),e.jsx(G,{isOpen:y,onClose:()=>f(!1),title:"Reset Password Error",message:e.jsx("span",{children:"Phone is not set for this user"}),buttons:[{label:"OK",onClick:()=>f(!1),variant:"neutral"}]}),N&&e.jsx(ae,{isOpen:N,onClose:()=>c(!1),role:s,routePrefix:u})]})]})}export{je as default};
