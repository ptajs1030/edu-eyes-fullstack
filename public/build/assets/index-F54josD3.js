import{r as o,j as t,a as w,u as J,H as ce,L as de}from"./app-D5PkqJhO.js";import{A as z}from"./action-modal-QsGzSfta.js";import{F as me}from"./form-modal-Pb_i8Wy7.js";import{t as p,T as ue}from"./index-CZIZRC5t.js";import{r as pe,u as H,w as he}from"./xlsx-BBWTpfDg.js";import{P as xe}from"./pagination-LDUIQiqt.js";import{T as ge}from"./table-CofsQgz5.js";import{A as fe}from"./app-layout-UEN9j-zU.js";import be from"./form-CIGvvnhE.js";/* empty css            */import"./proxy-DwSpO3zF.js";import"./index-D1OXLsko.js";import"./createLucideIcon-Bd7YlWb8.js";import"./button-BBAUQoM-.js";import"./index-BWI9RZWl.js";import"./index-Bq8KKhaY.js";import"./app-logo-icon-DOa4V4ri.js";import"./searchable-select-BgWMHm1z.js";const we=["Nama Lengkap","Orang Tua/Wali","Kelas","NIS","Tahun Masuk","Jenis Kelamin","Agama","Tempat Lahir","Tanggal Lahir","Alamat"],ye=["Nama Lengkap*","Orang Tua/Wali*","Kelas","NIS","Tahun Masuk*","Jenis Kelamin*","Agama","Tempat Lahir","Tanggal Lahir","Alamat"],Q=c=>c.replace(/\*/g,"").trim().toLowerCase().replace(/\s+/g,"_");function ke({isOpen:c,onClose:E}){const[F,h]=o.useState(null),[A,s]=o.useState(""),[d,M]=o.useState(!1),[y,C]=o.useState(!1),K=()=>{h(null),s(""),M(!1),C(!1)},_=()=>{y||(K(),E())},$=n=>{var u;s("");const r=((u=n.target.files)==null?void 0:u[0])??null;if(!r){h(null);return}if(r.size>2*1024*1024){s("Ukuran file maksimal 2MB"),h(null);return}const g=["application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/csv"];if(r.type&&!g.includes(r.type)){s("Tipe file tidak didukung. Upload .xlsx / .xls"),h(null);return}M(!0);const j=new FileReader;j.onload=N=>{var S;try{const U=(S=N.target)==null?void 0:S.result,O=pe(U,{type:"array"}),B=O.SheetNames[0],P=O.Sheets[B],L=(H.sheet_to_json(P,{header:1})[0]||[]).map(v=>Q(String(v??""))),D=we.map(Q),I=D.filter(v=>!L.includes(v)),T=L.filter(v=>!D.includes(v)&&v!=="");I.length>0?(s(`Header tidak lengkap. Field yang kurang: ${I.join(", ")}. Gunakan template yang disediakan.`),h(null)):T.length>0?(console.warn("Header tambahan ditemukan:",T),h(r),p.success("File valid. Header tambahan akan diabaikan.")):(h(r),p.success("File valid. Siap diimpor."))}catch{s("Gagal membaca file. Format Excel tidak valid."),h(null)}finally{M(!1)}},j.readAsArrayBuffer(r)},R=async()=>{var n;try{const r=await fetch(route("students.template"),{method:"GET"});if(!r.ok){const S=((n=await r.json().catch(()=>null))==null?void 0:n.message)||"Gagal mengunduh template";p.error(S);return}const g=await r.blob(),j=window.URL.createObjectURL(g),u=document.createElement("a"),N=r.headers.get("X-File-Name")||"template-import-siswa.xlsx";u.href=j,u.download=N,document.body.appendChild(u),u.click(),u.remove(),window.URL.revokeObjectURL(j),p.success("Template siswa berhasil diunduh")}catch{p.error("Terjadi kesalahan saat mengunduh template")}},m=()=>{if(!F){s("Pilih file terlebih dahulu");return}C(!0);const n=new FormData;n.append("file",F),w.post(route("students.import"),n,{onSuccess:()=>{_(),w.reload()},onError:r=>{const g=(r==null?void 0:r.file)||"Import gagal. Periksa isi file.";p.error(g)},onFinish:()=>C(!1),preserveScroll:!0})};return t.jsxs(me,{isOpen:c,onClose:_,title:"Import Data Siswa",onSubmit:n=>{n.preventDefault(),m()},children:[t.jsxs("div",{className:"space-y-5",children:[t.jsxs("div",{className:"rounded-lg border border-dashed border-gray-300 p-4",children:[t.jsx("label",{className:"mb-2 block text-sm font-medium text-gray-700",children:"Upload File (.xlsx / .xls)"}),t.jsx("input",{type:"file",accept:".xlsx,.xls,.csv",onChange:$,disabled:y,className:"block w-full text-sm text-gray-500 file:mr-4 file:rounded-md file:border-0 file:bg-blue-50 file:px-4 file:py-2.5 file:text-sm file:font-medium file:text-blue-700 hover:file:bg-blue-100"}),t.jsx("p",{className:"mt-2 text-xs text-gray-500",children:"Gunakan template agar header sesuai. Maks 2MB."}),A&&t.jsx("div",{className:"mt-2 text-xs text-red-600",children:A}),d&&t.jsxs("div",{className:"mt-2 inline-flex items-center text-xs text-gray-600",children:[t.jsxs("svg",{className:"mr-1.5 h-3.5 w-3.5 animate-spin",viewBox:"0 0 24 24",fill:"none",children:[t.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor"}),t.jsx("path",{className:"opacity-75",d:"M4 12a8 8 0 018-8v8z",fill:"currentColor"})]}),"Memvalidasi header..."]})]}),t.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between",children:[t.jsxs("button",{type:"button",onClick:R,className:"inline-flex items-center justify-center rounded-md border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50",disabled:y,children:[t.jsx("svg",{className:"mr-2 h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",d:"M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5 5m0 0l5-5m-5 5V3"})}),"Template"]}),t.jsxs("div",{className:"text-xs text-gray-500",children:["Header: ",ye.join(", ")]})]})]}),t.jsxs("div",{className:"mt-6 flex justify-end",children:[t.jsx("button",{type:"button",onClick:_,disabled:y,className:"mr-2 rounded-md border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50",children:"Batal"}),t.jsx("button",{type:"submit",disabled:y||!F||!!A||d,className:`inline-flex items-center rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm ${y?"cursor-not-allowed bg-blue-400":"hover:bg-blue-700"}`,children:y?"Memproses...":"Impor"})]})]})}const ve=[{title:"Siswa",href:"/students"}];function Re(){const{students:c,classrooms:E,sexes:F,statuses:h,religions:A,filters:s}=J().props,{flash:d}=J().props;o.useEffect(()=>{d!=null&&d.success&&p.success(d.success),d!=null&&d.error&&p.error(d.error)},[d]),o.useEffect(()=>{const e=l=>{T.current&&!T.current.contains(l.target)&&I(!1)};return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[]),o.useEffect(()=>{const e=s.classrooms?Array.isArray(s.classrooms)?s.classrooms.map(l=>Number(l)):[Number(s.classrooms)]:[];L(e)},[s.classrooms]);const M=s.classrooms?Array.isArray(s.classrooms)?s.classrooms.map(e=>Number(e)):[Number(s.classrooms)]:[],[y,C]=o.useState(!1),[K,_]=o.useState(!1),[$,R]=o.useState(null),[m,n]=o.useState([]),[r,g]=o.useState(null),[j,u]=o.useState(!1),[N,S]=o.useState(null),[U,O]=o.useState(""),[B,P]=o.useState(""),[f,L]=o.useState(M),[D,I]=o.useState(!1),T=o.useRef(null),v=e=>{const l=Number(e),i=f.includes(l)?f.filter(x=>x!==l):[...f,l];L(i),n([]);const k={search:s.search||void 0,sort:s.sort||void 0,direction:s.direction||void 0,status:s.status||void 0,page:1};i.length>0&&(k.classrooms=i),w.get(route("students.index"),k,{preserveState:!0,replace:!0,only:["students","filters"]})},V=()=>{L([]),n([]);const e={search:s.search||void 0,sort:s.sort||void 0,direction:s.direction||void 0,status:s.status||void 0,page:1};s.classrooms&&(e.classrooms=void 0),w.get(route("students.index"),e,{preserveState:!0,replace:!0,only:["students","filters"]})},G=(e=null)=>{R(e),C(!0)},X=async e=>{w.delete(`/students/${e}`,{onSuccess:()=>{w.reload()}})},Y=e=>{n(l=>l.includes(e)?l.filter(i=>i!==e):[...l,e])},Z=()=>{if(m.length===0){p.error("Pilih data siswa yang akan diexport terlebih dahulu");return}const e=c.data.filter(a=>m.includes(a.id)),l=e.map(a=>{var q,W;const oe=a.date_of_birth?new Date(a.date_of_birth).toISOString().slice(0,10):"-",ne={male:"Laki-laki",female:"Perempuan"},ie={active:"Aktif",inactive:"Tidak Aktif",graduated:"Lulus"};return{"Nama Lengkap":a.full_name||"-",NIS:{v:a.nis||"-",t:"s"},"Orang Tua/Wali":((q=a.parent)==null?void 0:q.full_name)||"-",Kelas:((W=a.classroom)==null?void 0:W.name)||"-","Jenis Kelamin":ne[a.gender]||a.gender,Agama:a.religion||"-","Tahun Masuk":a.entry_year||"-","Tempat Lahir":a.birth_place||"-","Tanggal Lahir":oe,Alamat:a.address||"-",Status:ie[a.status]||a.status}}),i=H.json_to_sheet(l),k=[{width:25},{width:25},{width:15},{width:15},{width:12},{width:15},{width:15},{width:15},{width:15},{width:30},{width:12}];i["!cols"]=k;const x=H.book_new();H.book_append_sheet(x,i,"Data Siswa");const b="data-siswa.xlsx";try{he(x,b),p.success(`Berhasil mengekspor ${e.length} data siswa`,{description:`File: ${b}`})}catch(a){console.error("Export error:",a),p.error("Gagal mengekspor data. Silakan coba lagi.")}},ee=e=>{const l=s.direction==="asc"?"desc":"asc";let i=e;e==="classroom.name"&&(i="class_name"),w.get(route("students.index"),{sort:i,direction:l,classrooms:f.length>0?f:void 0,search:s.search||void 0},{preserveState:!0})},te=async()=>{var e;if(m.length!==0)try{const l=await fetch("/bulk-kartu-siswa",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":((e=document.querySelector('meta[name="csrf-token"]'))==null?void 0:e.content)||""},body:JSON.stringify({student_ids:m})});if(!l.ok)throw new Error("Gagal download file PDF");const i=await l.blob(),k=window.URL.createObjectURL(i),x=document.createElement("a");x.href=k,x.download="kumpulan-kartu-siswa.pdf",x.click()}catch{p.error("Gagal download kartu siswa.")}},se=[{key:"profile_picture",label:"Foto",sortable:!1},{key:"full_name",label:"Nama Siswa",sortable:!0},{key:"parent.full_name",label:"Nama Orang Tua/wali",sortable:!1},{key:"classroom.name",label:"Kelas",sortable:!0},{key:"nis",label:"NIS",sortable:!0},{key:"entry_year",label:"Tahun Masuk",sortable:!0},{key:"gender",label:"Jenis Kelamin",sortable:!0},{key:"religion",label:"Agama",sortable:!0},{key:"date_of_birth",label:"Tempat, Tanggal Lahir",sortable:!0},{key:"address",label:"Alamat",sortable:!1},{key:"status",label:"Status",sortable:!0},{key:"actions",label:"Aksi",sortable:!1}],ae=e=>{switch(e){case"active":return"bg-green-100 text-green-800";case"inactive":return"bg-red-100 text-red-800";case"graduated":return"bg-blue-100 text-blue-800";default:return"bg-gray-100 text-gray-800"}},re=e=>{switch(e){case"active":return"Aktif";case"inactive":return"Tidak Aktif";case"graduated":return"Lulus";default:return e}},le=e=>{switch(e){case"male":return"Laki-Laki";case"female":return"Perempuan";default:return e}};return t.jsxs(fe,{breadcrumbs:ve,children:[t.jsx(ce,{title:"Siswa"}),t.jsx(ue,{position:"top-right",richColors:!0}),t.jsxs("div",{className:"flex flex-col gap-6 rounded-xl bg-white p-6 text-black shadow-lg",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("input",{type:"text",placeholder:"Cari siswa...",defaultValue:s.search||"",onChange:e=>{n([]),w.get(route("students.index"),{...s,search:e.target.value},{preserveState:!0})},className:"w-64 rounded border px-3 py-1 text-sm"}),t.jsxs("select",{value:s.show||"10",onChange:e=>{n([]),w.get(route("students.index"),{...s,show:e.target.value},{preserveState:!0})},className:"rounded border px-2 py-1 text-sm",children:[t.jsx("option",{value:"10",children:"Show 10 data"}),t.jsx("option",{value:"20",children:"Show 20 data"}),t.jsx("option",{value:"all",children:"Show All"})]}),t.jsxs("select",{value:s.status||"",onChange:e=>{n([]),w.get(route("students.index"),{...s,status:e.target.value},{preserveState:!0})},className:"rounded border px-2 py-1 text-sm",children:[t.jsx("option",{value:"",children:"Semua Status"}),h.map(e=>t.jsx("option",{value:e.value,children:e.label},e.value))]}),t.jsxs("div",{className:"relative",ref:T,children:[t.jsxs("button",{onClick:()=>I(!D),className:"rounded bg-gray-200 px-3 py-1 text-sm font-medium text-gray-700 hover:bg-gray-300",children:["Filter Kelas ",f.length>0?`(${f.length})`:""]}),D&&t.jsxs("div",{className:"absolute top-full left-0 z-10 mt-1 w-64 rounded-md border border-gray-200 bg-white p-3 shadow-lg",children:[t.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[t.jsx("span",{className:"text-sm font-medium",children:"Filter by Kelas"}),f.length>0&&t.jsx("button",{onClick:V,className:"text-xs text-blue-600 hover:text-blue-800",children:"Clear"})]}),t.jsx("div",{className:"max-h-48 overflow-y-auto",children:E.map(e=>t.jsxs("label",{className:"flex items-center space-x-2 py-1",children:[t.jsx("input",{type:"checkbox",checked:f.includes(e.id),onChange:()=>v(e.id),className:"rounded border-gray-300"}),t.jsx("span",{className:"text-sm",children:e.name})]},e.id))})]})]}),t.jsx("button",{disabled:m.length===0||c.data.length===0,onClick:Z,className:`rounded bg-indigo-600 px-3 py-1 text-sm font-medium text-white transition ${m.length===0||c.data.length===0?"cursor-not-allowed opacity-50":"hover:cursor-pointer hover:bg-indigo-700"}`,children:"Ekspor Data"}),t.jsx("button",{disabled:m.length===0||c.data.length===0,onClick:te,className:`rounded bg-indigo-700 px-3 py-1 text-sm font-medium text-white transition ${m.length===0||c.data.length===0?"cursor-not-allowed opacity-50":"hover:cursor-pointer hover:bg-indigo-700"}`,children:"Print Kartu"}),t.jsxs("button",{onClick:()=>_(!0),className:"flex items-center gap-2 rounded bg-blue-600 px-3 py-1 text-sm font-medium text-white hover:bg-blue-700",children:[t.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5-5 5 5M12 5v14"})}),t.jsx("span",{children:"Impor Data"})]})]}),t.jsx("button",{onClick:()=>G(null),className:"rounded bg-green-600 px-3 py-1 text-sm font-medium text-white transition hover:cursor-pointer hover:bg-green-700",children:"Tambah Siswa"})]}),t.jsx(ge,{headers:se,data:c.data,sortColumn:s.sort??"",sortDirection:s.direction==="asc"||s.direction==="desc"?s.direction:"asc",onSort:ee,onSelectAll:e=>n(e?c.data.map(l=>l.id):[]),selectedIds:m,rowRender:e=>{var l,i,k,x;return t.jsxs("tr",{className:"border-b",children:[t.jsx("td",{className:"w-[10px] p-3 text-sm",children:t.jsx("input",{type:"checkbox",checked:m.includes(e.id),onChange:()=>Y(e.id)})}),t.jsx("td",{className:"p-3",children:t.jsx("div",{className:"flex justify-center",children:e.profile_picture?t.jsx("img",{src:`/storage/${e.profile_picture}`,alt:e.full_name,className:"h-10 w-10 rounded-full border border-gray-300 object-cover"}):t.jsx("img",{src:`https://api.dicebear.com/9.x/initials/svg?seed=${encodeURIComponent(e.full_name)}`,alt:e.full_name,className:"h-10 w-10 rounded-full border border-gray-300 object-cover"})})}),t.jsx("td",{className:"p-3 text-sm",children:e.full_name}),t.jsx("td",{className:"p-3 text-sm",children:((l=e.parent)==null?void 0:l.full_name)||"-"}),t.jsx("td",{className:"p-3 text-sm",children:((i=e.classroom)==null?void 0:i.name)||"-"}),t.jsx("td",{className:"p-3 text-sm",children:e.nis||"-"}),t.jsx("td",{className:"p-3 text-sm",children:e.entry_year}),t.jsx("td",{className:"p-3 text-sm",children:le(e.gender)}),t.jsx("td",{className:"p-3 text-sm",children:e.religion||"-"}),t.jsx("td",{className:"p-3 text-sm",children:(()=>{const b=e.birth_place,a=e.date_of_birth;return b&&a?`${b}, ${a}`:b||a||"-"})()}),t.jsx("td",{className:"p-3 text-sm",children:e.address?e.address.length>70?e.address.substring(0,70)+"...":e.address:"-"}),t.jsx("td",{className:"p-3 text-sm",children:t.jsx("span",{className:`inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${ae(e.status)}`,children:re(e.status)})}),t.jsxs("td",{className:"flex justify-center gap-2 p-3",children:[t.jsx("button",{onClick:()=>G(e),className:"rounded bg-blue-500 px-3 py-1 text-sm font-medium text-white hover:cursor-pointer",children:"Edit"}),t.jsx(de,{href:route("students.attendance",e.id),className:`rounded px-3 py-1 text-sm font-medium text-white ${(k=e.classroom)!=null&&k.name?"bg-sky-500 hover:cursor-pointer hover:bg-sky-600":"cursor-not-allowed bg-sky-300"}`,onClick:b=>{var a;(a=e.classroom)!=null&&a.name||b.preventDefault()},title:(x=e.classroom)!=null&&x.name?"":"Siswa harus memiliki kelas untuk melihat kehadiran",children:"Kehadiran"}),t.jsx("button",{onClick:async()=>{S(e),u(!0);const a=await(await fetch(route("student.qrcode.preview",{student:e.id}))).text();P(a),O(route("kartu-siswa",{student_id:e.id}))},className:"rounded bg-sky-500 px-3 py-1 text-sm font-medium text-white hover:cursor-pointer",children:"Kartu"}),t.jsx("button",{onClick:()=>g(e),className:"rounded bg-red-500 px-3 py-1 text-sm font-medium text-white hover:cursor-pointer",children:"Hapus"})]})]},e.id)}}),t.jsx(xe,{links:c.links}),t.jsx(be,{isOpen:y,onClose:()=>C(!1),student:$,classrooms:E,sexes:F,statuses:h,religions:A}),t.jsx(z,{isOpen:!!r,onClose:()=>g(null),title:"Konfirmasi Penghapusan",message:t.jsxs("span",{children:["Apakah Anda yakin ingin menghapus siswa ",t.jsx("strong",{children:r==null?void 0:r.full_name}),"?"]}),buttons:[{label:"Batal",onClick:()=>g(null),variant:"neutral"},{label:"Ya, Hapus",onClick:()=>{r&&(X(r.id),g(null))},variant:"danger"}]}),t.jsx(z,{isOpen:j,onClose:()=>{u(!1),S(null),P(""),O("")},title:`Kartu Pelajar - ${N==null?void 0:N.full_name}`,message:t.jsxs("div",{className:"flex flex-col items-center gap-4",children:[t.jsx("div",{dangerouslySetInnerHTML:{__html:B},className:"h-[200px] w-[200px]"}),t.jsx("a",{href:U,download:!0,className:"mt-2 rounded bg-blue-600 px-4 py-2 text-sm text-white hover:bg-blue-700",children:"Download PDF"})]}),buttons:[{label:"Close",onClick:()=>u(!1),variant:"neutral"}]})]}),t.jsx(ke,{isOpen:K,onClose:()=>_(!1)})]})}export{Re as default};
